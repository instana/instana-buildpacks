---

var:
  instana-buildpack-git-repo-config: &instana-buildpack-git-repo-config
    uri: https://github.com/instana/instana-buildpack.git
    username: ((project-berlin-gh-token))
    password: x-oauth-basic
    branch: ((branch))

resource_types:

  - name: artifactory-resource
    type: docker-image
    source:
      repository: instana/artifactory-resource
      tag: latest

  - name: npm-resource
    type: docker-image
    source:
      repository: idahobean/npm-resource

  - name: instana-version-resource
    type: docker-image
    source:
      repository: instana/instana-version-resource
      tag: latest

  - name: gcs-resource
    type: docker-image
    source:
      repository: frodenas/gcs-resource

  - name: slack-notification
    type: docker-image
    source:
      repository: cfcommunity/slack-notification-resource
      tag: latest

resources:

  - name: pipeline-source
    type: git
    icon: github
    source:
      <<: *instana-buildpack-git-repo-config
      paths:
      - ci/pipeline.yml

  - name: google-cloud-run-buildpack-branch-source
    type: git
    icon: github
    source:
      <<: *instana-buildpack-git-repo-config
      paths:
      - google-cloud-platform/cloud-run/

  - name: instana-jvm-collector
    type: artifactory-resource
    icon: github
    source:
      download_key: ((instana-download-key))
      group: com.instana
      artifact: standalone-collector-jvm
      file_name: standalone-collector-jvm-:version.jar
      skip_ssl_verification: true

  - name: instana-netcore-dependencies
    type: artifactory-resource
    icon: github
    source:
      download_key: ((instana-download-key))
      group: com.instana
      artifact: core-clr-extension
      file_name: core-clr-extension-:version.zip
      skip_ssl_verification: true

  - name: instana-gcr-npm-package
    type: npm-resource
    icon: cube-unfolded
    source:
      package_name: '@instana/google-cloud-run'
      registry: https://registry.npmjs.org/

  - name: cnb-package-builder-source
    type: git
    icon: github
    source:
      <<: *instana-buildpack-git-repo-config
      paths:
      - &cnb-packager-src-path ci/images/cnb-packager

  - name: cnb-package-builder-image
    type: docker-image
    icon: cube
    source:
      repository: &cnb-package-builder-image-name gcr.io/instana-agent-qa/cnb/package-builder
      username: _json_key
      password: ((project-berlin-tests-gcp-instana-qa))

  - name: gcr-deployer-source
    type: git
    icon: github
    source:
      <<: *instana-buildpack-git-repo-config
      paths:
      - &gcr-deployer-source ci/images/gcr-deployer

  - name: gcr-deployer-image
    type: docker-image
    icon: cube
    source:
      repository: &gcr-deployer-image-name gcr.io/instana-agent-qa/cnb/gcr-deployer
      username: _json_key
      password: ((project-berlin-tests-gcp-instana-qa))

  - name: google-cloud-run-buildpack-snapshot-image
    type: docker-image
    icon: cube
    source:
      repository: &buildpack-snapshot-image-name gcr.io/instana-agent-qa/buildpacks/cloudrun
      username: _json_key
      password: ((project-berlin-tests-gcp-instana-qa))

  - name: google-cloud-run-buildpack-release-image
    type: docker-image
    icon: cube
    source:
      repository: &buildpack-release-image-name containers.instana.io/instana/release/google/buildpack
      username: ((containers-instana-io-creds.username))
      password: ((containers-instana-io-creds.password))

  - name: nodejs-test-source
    type: git
    icon: github
    source:
      <<: *instana-buildpack-git-repo-config
      paths:
      - &test-apps-nodejs-source-path google-cloud-platform/cloud-run/test/apps/nodejs

  - name: nodejs-test-image
    type: docker-image
    icon: cube
    source:
      repository: &test-apps-nodejs-image-name gcr.io/instana-agent-qa/buildpacks/test/nodejs
      username: _json_key
      password: ((project-berlin-tests-gcp-instana-qa))

  - name: netcore-test-source
    type: git
    icon: github
    source:
      <<: *instana-buildpack-git-repo-config
      paths:
      - &test-apps-netcore-source-path google-cloud-platform/cloud-run/test/apps/netcore

  - name: netcore-test-image
    type: docker-image
    icon: cube
    source:
      repository: &test-apps-netcore-image-name gcr.io/instana-agent-qa/buildpacks/test/netcore
      username: _json_key
      password: ((project-berlin-tests-gcp-instana-qa))

  - name: java-mvn-test-source
    type: git
    icon: github
    source:
      <<: *instana-buildpack-git-repo-config
      paths:
      - &test-apps-java-mvn-source-path google-cloud-platform/cloud-run/test/apps/java/mvn

  - name: java-mvn-test-image
    type: docker-image
    icon: cube
    source:
      repository: &test-apps-java-mvn-image-name gcr.io/instana-agent-qa/buildpacks/test/java-mvn
      username: _json_key
      password: ((project-berlin-tests-gcp-instana-qa))

  - name: java-gradle-test-source
    type: git
    icon: github
    source:
      <<: *instana-buildpack-git-repo-config
      paths:
      - &test-apps-java-gradle-source-path google-cloud-platform/cloud-run/test/apps/java/gradle

  - name: java-gradle-test-image
    type: docker-image
    icon: cube
    source:
      repository: &test-apps-java-gradle-image-name gcr.io/instana-agent-qa/buildpacks/test/java-gradle
      username: _json_key
      password: ((project-berlin-tests-gcp-instana-qa))

  - name: instana-saas-version
    type: instana-version-resource
    source:
      endpoint: ((instana-qa.api_url))
      api_token: ((instana-qa.api_token))

  - name: google-cloud-run-buildpack-main-version
    type: semver
    icon: alpha
    source: &semver-version
      <<: *instana-buildpack-git-repo-config
      driver: git
      branch: &release-branch main
      file: google-cloud-platform/cloud-run.version
      commit_message: Bump buildpack version to %version%

  - name: google-cloud-run-buildpack-builds-branch
    type: gcs-resource
    source:
      bucket: instana-buildpacks
      json_key: ((project-berlin-tests-gcp-instana-qa))
      regexp: builds/google-cloud-run-buildpack-((branch))-(.*).tgz

  - name: google-cloud-run-buildpack-builds-main
    type: gcs-resource
    source:
      bucket: instana-buildpacks
      json_key: ((project-berlin-tests-gcp-instana-qa))
      regexp: builds/google-cloud-run-buildpack-main-(.*).tgz

  - name: slack-alert-team-agent
    type: slack-notification
    source:
      url: ((slack-webhook-team-agent.webhoook_url))

jobs:

  - name: self-update
    max_in_flight: 1
    plan:
      - get: pipeline-source
        trigger: true
      - set_pipeline: self
        file: pipeline-source/ci/pipeline.yml
        vars:
          branch: ((branch))
          project-berlin-gh-token: ((project-berlin-gh-token))
          artifacts-instana-io.username: ((artifacts-instana-io.username))
          artifacts-instana-io.password: ((artifacts-instana-io.password))
          containers-instana-io-creds.username: ((containers-instana-io-creds.username))
          containers-instana-io-creds.password: ((containers-instana-io-creds.password))
          gcp-e2e-tests-project: instana-agent-qa
          gcp-e2e-tests-region: us-west1
          project-berlin-gcp-account-key: ((project-berlin-gcp-account-key))
          project-berlin-tests-gcp-instana-qa: ((project-berlin-tests-gcp-instana-qa))
          instana-qa.endpoint_host: ((instana-qa.endpoint_host))
          instana-qa.serverless_endpoint_url: ((instana-qa.serverless_endpoint_url))
          instana-qa.agent_key: ((instana-qa.agent_key))
          instana-qa.api_url: ((instana-qa.api_url))
          instana-qa.api_token: ((instana-qa.api_token))
          gcr-deployment-account-key: ((gcr-deployment-account-key))
          slack-webhook-team-agent.webhoook_url: ((slack-webhook-team-agent.webhoook_url))

  - name: update-buildpack-version-on-saas-update
    max_in_flight: 1
    plan:
      - in_parallel:
        - get: instana-saas-version
          trigger: true
      - put: google-cloud-run-buildpack-main-version
        params:
          bump: minor
          pre: alpha

  - name: build-package-builder-image
    max_in_flight: 1
    plan:
      - in_parallel:
        - get: cnb-package-builder-source
          trigger: true
      - put: cnb-package-builder-image
        params:
          build: cnb-package-builder-source/ci/images/cnb-packager
        get_params:
          skip_download: true

  - name: build-gcr-deployer-image
    max_in_flight: 1
    plan:
      - in_parallel:
        - get: gcr-deployer-source
          trigger: true
      - put: gcr-deployer-image
        params:
          build: gcr-deployer-source/ci/images/gcr-deployer
        get_params:
          skip_download: true

  - name: build-buildpack-snapshot
    max_in_flight: 1
    plan:
      - in_parallel:
        - get: cnb-package-builder-image
          passed: [build-package-builder-image]
          params:
            skip_download: true
        - get: google-cloud-run-buildpack-branch-source
          trigger: true
        - get: instana-jvm-collector
          trigger: true
        - get: instana-netcore-dependencies
          trigger: true
        - get: instana-gcr-npm-package
          trigger: true
      - task: prepare-nodejs-instrumentation
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: node
              tag: 15-buster
          outputs:
            - name: instana-nodejs-instrumentation
          run:
            path: /bin/bash
            args:
              - -ce
              - |
                mkdir nodejs-instrumentation
                (cd nodejs-instrumentation && npm install @instana/google-cloud-run)
                tar czf instana-nodejs-instrumentation/nodejs-instrumentation.tgz -C nodejs-instrumentation .
      - task: create-buildpack-packages
        privileged: true
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: gcr.io/instana-agent-qa/cnb/package-builder # This image provides a Docker-in-Docker setup
              tag: latest
              username: _json_key
              password: ((project-berlin-tests-gcp-instana-qa))
          inputs:
            - name: google-cloud-run-buildpack-branch-source
            - name: instana-jvm-collector
            - name: instana-netcore-dependencies
            - name: instana-nodejs-instrumentation
            - name: instana-gcr-npm-package
          outputs:
            - name: buildpack-packages
          params:
            IMAGE_NAME: *buildpack-snapshot-image-name
          run:
            path: /bin/bash
            args:
              - -ce
              - |
                cp instana-jvm-collector/standalone-collector-jvm-*.jar google-cloud-run-buildpack-branch-source/google-cloud-platform/cloud-run/src/instrumentation/jvm/standalone-collector-jvm.jar
                cp instana-netcore-dependencies/core-clr-extension-*.zip google-cloud-run-buildpack-branch-source/google-cloud-platform/cloud-run/src/instrumentation/netcore/core-clr-extension.zip
                cp instana-nodejs-instrumentation/nodejs-instrumentation.tgz google-cloud-run-buildpack-branch-source/google-cloud-platform/cloud-run/src/instrumentation/nodejs/nodejs-instrumentation.tgz

                # pack package-buildpack buildpack-packages/instana-cloudrun-buildpack.cnb --config google-cloud-run-buildpack-branch-source/google-cloud-platform/cloud-run/package.toml --format file

                # Delete .gitignore files we keep around
                find google-cloud-run-buildpack-branch-source/google-cloud-platform/cloud-run/src -name .gitignore | xargs -I {} rm -f {}

                # start docker
                source /docker-lib.sh
                start_docker

                pack package-buildpack "${IMAGE_NAME}" --config google-cloud-run-buildpack-branch-source/google-cloud-platform/cloud-run/package.toml --format image
                docker save -o buildpack-packages/instana-cloudrun-buildpack.image "${IMAGE_NAME}"
      - put: google-cloud-run-buildpack-snapshot-image
        params:
          load_repository: *buildpack-snapshot-image-name
          load_file: buildpack-packages/instana-cloudrun-buildpack.image
        get_params:
          skip_download: true

  - name: end-to-end-tests
    max_in_flight: 1
    plan:
      - in_parallel:
        - get: cnb-package-builder-image
          passed: [build-package-builder-image]
          params:
            skip_download: true
        - get: gcr-deployer-image
          passed: [build-gcr-deployer-image]
          params:
            skip_download: true
        - get: google-cloud-run-buildpack-snapshot-image
          passed: [build-buildpack-snapshot]
          trigger: true
          params:
            save: true
        - get: google-cloud-run-buildpack-branch-source
        - get: nodejs-test-source
        - get: netcore-test-source
        - get: java-mvn-test-source
        - get: java-gradle-test-source
      - in_parallel:
        - task: prepare-buildpack-image-for-gcs-upload
          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: gcr.io/instana-agent-qa/cnb/package-builder
                tag: latest
                username: _json_key
                password: ((project-berlin-tests-gcp-instana-qa))
            inputs:
              - name: google-cloud-run-buildpack-branch-source
              - name: google-cloud-run-buildpack-snapshot-image
            outputs:
              - name: google-cloud-run-buildpack-image
            params:
              BRANCH: ((branch))
            run:
              path: /bin/bash
              args:
                - -ce
                - |
                  short_ref=$(cat google-cloud-run-buildpack-branch-source/.git/short_ref)
                  tar czf google-cloud-run-buildpack-image/google-cloud-run-buildpack-${BRANCH}-${short_ref}.tgz -C google-cloud-run-buildpack-snapshot-image .
        - task: build-nodejs-test-image
          privileged: true
          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: gcr.io/instana-agent-qa/cnb/package-builder
                tag: latest
                username: _json_key
                password: ((project-berlin-tests-gcp-instana-qa))
            inputs:
              - name: google-cloud-run-buildpack-snapshot-image
              - name: nodejs-test-source
            outputs:
              - name: nodejs-test-image
            params: &build-test-image-param
              TEST_APP_IMAGE_NAME: *test-apps-nodejs-image-name
              JSON_KEY: ((gcr-deployment-account-key))
              SOURCE_DIRECTORY: nodejs-test-source/google-cloud-platform/cloud-run/test/apps/nodejs
              IMAGE_FILE: nodejs-test-image/docker.image
            run: &build-test-image-run
              path: /bin/bash
              args:
                - -ce
                - |
                  source /docker-lib.sh
                  start_docker

                  docker pull gcr.io/buildpacks/builder
                  docker login -u _json_key -p "${JSON_KEY}" https://gcr.io

                  buildpack_image=$(cat google-cloud-run-buildpack-snapshot-image/repository)

                  (
                    cd "${SOURCE_DIRECTORY}" \
                    && pack build "${TEST_APP_IMAGE_NAME}" \
                      --buildpack from=builder \
                      --buildpack ${buildpack_image} \
                      --builder gcr.io/buildpacks/builder \
                  )

                  docker save "${TEST_APP_IMAGE_NAME}" -o "${IMAGE_FILE}"
        - task: build-netcore-test-image
          privileged: true
          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: gcr.io/instana-agent-qa/cnb/package-builder
                tag: latest
                username: _json_key
                password: ((project-berlin-tests-gcp-instana-qa))
            inputs:
              - name: google-cloud-run-buildpack-snapshot-image
              - name: netcore-test-source
            outputs:
              - name: netcore-test-image
            params:
              <<: *build-test-image-param
              TEST_APP_IMAGE_NAME: *test-apps-netcore-image-name
              SOURCE_DIRECTORY: netcore-test-source/google-cloud-platform/cloud-run/test/apps/netcore
              IMAGE_FILE: netcore-test-image/docker.image
            run: *build-test-image-run
        - task: build-java-mvn-test-image
          privileged: true
          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: gcr.io/instana-agent-qa/cnb/package-builder
                tag: latest
                username: _json_key
                password: ((project-berlin-tests-gcp-instana-qa))
            inputs:
              - name: google-cloud-run-buildpack-snapshot-image
              - name: java-mvn-test-source
            outputs:
              - name: java-mvn-test-image
            params:
              <<: *build-test-image-param
              TEST_APP_IMAGE_NAME: *test-apps-java-mvn-image-name
              SOURCE_DIRECTORY: java-mvn-test-source/google-cloud-platform/cloud-run/test/apps/java/mvn
              IMAGE_FILE: java-mvn-test-image/docker.image
            run: *build-test-image-run
        - task: build-java-gradle-test-image
          privileged: true
          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: gcr.io/instana-agent-qa/cnb/package-builder
                tag: latest
                username: _json_key
                password: ((project-berlin-tests-gcp-instana-qa))
            inputs:
              - name: google-cloud-run-buildpack-snapshot-image
              - name: java-gradle-test-source
            outputs:
              - name: java-gradle-test-image
            params:
              <<: *build-test-image-param
              TEST_APP_IMAGE_NAME: *test-apps-java-gradle-image-name
              SOURCE_DIRECTORY: java-gradle-test-source/google-cloud-platform/cloud-run/test/apps/java/gradle
              IMAGE_FILE: java-gradle-test-image/docker.image
            run: *build-test-image-run
      - in_parallel:
        - put: netcore-test-image
          params:
            load_repository: *test-apps-netcore-image-name
            load_file: netcore-test-image/docker.image
          get_params:
            skip_download: true
        - put: nodejs-test-image
          params:
            load_repository: *test-apps-nodejs-image-name
            load_file: nodejs-test-image/docker.image
          get_params:
            skip_download: true
        - put: java-mvn-test-image
          params:
            load_repository: *test-apps-java-mvn-image-name
            load_file: java-mvn-test-image/docker.image
          get_params:
            skip_download: true
        - put: java-gradle-test-image
          params:
            load_repository: *test-apps-java-gradle-image-name
            load_file: java-gradle-test-image/docker.image
          get_params:
            skip_download: true
      - in_parallel:
        - task: run-nodejs-test-app-on-gcr
          timeout: 5m
          config:
            platform: linux
            image_resource: &e2e-image-resource
              type: docker-image
              source:
                repository: *gcr-deployer-image-name
                tag: latest
                username: _json_key
                password: ((project-berlin-tests-gcp-instana-qa))
            params: &e2e-params
              GCP_KEY_JSON: ((project-berlin-tests-gcp-instana-qa))
              PROJECT_NAME: ((gcp-e2e-tests-project))
              REGION: ((gcp-e2e-tests-region))
              SERVICE_NAME: gcr-cnb-test-e2e-nodejs
              ENDPOINT_URL: ((instana-qa.serverless_endpoint_url))
              AGENT_KEY: ((instana-qa.agent_key))
              APP_IMAGE_NAME: *test-apps-nodejs-image-name
              INSTANA_API_ENDPOINT: ((instana-qa.api_url))
              INSTANA_API_TOKEN: ((instana-qa.api_token))
            run: &e2e-run
              path: /bin/bash
              args:
                - -ce
                - |
                  echo "${GCP_KEY_JSON}" > keyfile.json
                  gcloud auth activate-service-account --key-file keyfile.json
                  gcloud run deploy "${SERVICE_NAME}" \
                    --image=${APP_IMAGE_NAME} \
                    --project=${PROJECT_NAME} \
                    --region=${REGION} \
                    --platform=managed \
                    --set-env-vars=INSTANA_ENDPOINT_URL=${ENDPOINT_URL},INSTANA_AGENT_KEY=${AGENT_KEY} \
                    --allow-unauthenticated

                  service_url=$(gcloud run services list --platform=managed --project ${PROJECT_NAME} | grep "${SERVICE_NAME}" | awk '{ print $4 }')

                  while true; do
                    curl --silent --show-error ${service_url} > /dev/null

                    query_result=$(curl --silent --fail --show-error ${INSTANA_API_ENDPOINT}/api/application-monitoring/metrics/services \
                      --header "Authorization: apiToken ${INSTANA_API_TOKEN}" \
                      --header "Content-type: application/json" \
                      --data "{\"timeFrame\":{\"windowSize\":"60000"},\"nameFilter\":\"${SERVICE_NAME}\",\"technologies\":[\"googleCloudRunServiceRevision\"],\"metrics\":[{\"metric\":\"calls\",\"aggregation\":\"SUM\"}]}" \
                      | jq '.items[]')

                    if echo "${query_result}" | jq '[ .metrics."calls.sum"[][1] ] | add' > 0; then

                      # Some calls found
                      echo "Found calls for Cloud Run service: $(echo "${query_result}" | jq .)"

                      exit 0
                    fi
                  done
        - task: run-netcore-test-app-on-gcr
          timeout: 5m
          config:
            platform: linux
            image_resource: *e2e-image-resource
            params:
              <<: *e2e-params
              SERVICE_NAME: gcr-cnb-test-e2e-netcore
              APP_IMAGE_NAME: *test-apps-netcore-image-name
            run: *e2e-run
        - task: run-java-mvn-test-app-on-gcr
          timeout: 5m
          config:
            platform: linux
            image_resource: *e2e-image-resource
            params:
              <<: *e2e-params
              SERVICE_NAME: gcr-cnb-test-e2e-java-mvn
              APP_IMAGE_NAME: *test-apps-java-mvn-image-name
            run: *e2e-run
        - task: run-java-gradle-test-app-on-gcr
          timeout: 5m
          config:
            platform: linux
            image_resource: *e2e-image-resource
            params:
              <<: *e2e-params
              SERVICE_NAME: gcr-cnb-test-e2e-java-gradle
              APP_IMAGE_NAME: *test-apps-java-gradle-image-name
            run: *e2e-run
      - put: google-cloud-run-buildpack-builds-branch
        params:
          file: google-cloud-run-buildpack-image/google-cloud-run-buildpack-*.tgz
          content_type: application/octet-stream
    on_failure:
      put: slack-alert-team-agent
      params:
        channel: '#agent-java-underground'
        text: End-to-end tests for the Google Cloud Run CNB version failed!

  - name: release-buildpack
    max_in_flight: 1
    plan:
      - in_parallel:
        - get: google-cloud-run-buildpack-builds-main
          trigger: true
        - get: google-cloud-run-buildpack-main-version
          params:
            bump: final
      - task: ensure-release-only-from-main-pipeline # Avoid that branch pipelines execute release jobs
        config:
          platform: linux
          image_resource: &e2e-image-resource
            type: docker-image
            source:
              repository: busybox
              tag: latest
          params:
            CURRENT_BRANCH: ((branch))
            RELEASE_BRANCH: *release-branch
          run: &e2e-run
            path: /bin/bash
            args:
              - -ce
              - |
                if [ "${CURRENT_BRANCH}" != "${RELEASE_BRANCH}" ]; then
                  echo "Release jobs are allowed only from the '${RELEASE_BRANCH}'; this pipeline watches the '${CURRENT_BRANCH}' branch"
                  exit 1;
                fi
      - load_var: version_number
        file: google-cloud-run-buildpack-main-version/version
        reveal: true
      - task: prep-buildpack-file
        timeout: 5m
        config:
          platform: linux
          image_resource: &e2e-image-resource
            type: docker-image
            source:
              repository: *gcr-deployer-image-name
              tag: latest
              username: _json_key
              password: ((project-berlin-tests-gcp-instana-qa))
          inputs:
            - name: google-cloud-run-buildpack-builds-main
          outputs: 
            - name: buildpack-build
          run: &e2e-run
            path: /bin/bash
            args:
              - -ce
              - |
                tar xzf google-cloud-run-buildpack-builds-main/google-cloud-run-buildpack-*.tgz -C buildpack-build/
      - put: google-cloud-run-buildpack-release-image
        params:
          load: buildpack-build/
          tag_file: google-cloud-run-buildpack-main-version/version
          tag_as_latest: true
        get_params:
          skip_download: true
      - put: google-cloud-run-buildpack-main-version
        params:
          bump: patch
          pre: alpha
      - put: slack-alert-team-agent
        params:
          channel: '#agent-java-underground'
          text: New Google Cloud Run CNB version ((.:version_number)) was published!
